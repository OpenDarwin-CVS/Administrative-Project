#!/usr/bin/perl

@users = `nidump passwd .`;
open PASS, ">/var/odpass";
chmod 0600, "/var/odpass";
for($i = 0; defined $users[$i]; $i++) {
	$_ = $users[$i];
	chomp;
	$pwdline = $_;
	@line = split /\:/;
	$uid = $line[2];

	if( $uid < 500 ) {
		next;
	}

	print PASS "$pwdline\n"
}
close PASS;

@groups = `nidump group .`;
open PASS, ">/var/odgroup";
chmod 0600, "/var/odgroup";
for($i = 0; defined $groups[$i]; $i++) {
	$_ = $groups[$i];
	chomp;
	$pwdline = $_;
	@line = split /\:/;
	$gid = $line[2];

	if( $gid < 500 ) {
		next;
	}

	print PASS "$pwdline\n"
}
close PASS;

system("cat /var/odpass | ssh -i /var/root/.ssh/id_dsa.opendarwin dulcinea.opendarwin.org niload passwd .");
system("cat /var/odgroup | ssh -i /var/root/.ssh/id_dsa.opendarwin dulcinea.opendarwin.org niload group .");

open PASS, "/var/odpass";
while(<PASS>) {
	chomp;
	@line = split /\:/;
	$user = $line[0];
	$uid = $line[2];

	if( $uid < 500 ) {
		next;
	}

	if( ! -d "/Users/$user/.ssh" ) {
		next;
	}

	`rsync -apogv -e ssh /Users/$user/.ssh dulcinea.opendarwin.org:/Users/$user/`;
	# rsync doesn't seem to preserve ownership on the homedir, only
	# on the .ssh directory and lower.
	system("ssh dulcinea.opendarwin.org chown $user /Users/$user");
}
close PASS;

unlink("/var/odpass");
unlink("/var/odgroup");
