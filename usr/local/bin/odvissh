#!/usr/bin/perl -U
##
## odvissh
## Kevin Van Vechten | kevin@opendarwin.org
##
## This script, when run as a privileged user, extracts the
## specified users' authorized keys file from the database
## and invokes the $EDITOR.  The contents of the file after
## successful termination of $EDITOR are then loaded into
## the database and the authorized_keys file is regenerated.
##
## C O M M A N D  L I N E   A R G U M E N T S 
##

$user     = $ARGV[0];
#$user     = $ENV{'OD_USER_NAME'};		# login name
#$passwd   = $ENV{'OD_PASSWORD'};		# password
$editor   = defined($ENV{'EDITOR'}) ? $ENV{'EDITOR'} : 
            (defined($ENV{'VISUAL'}) ? $ENV{'VISUAL'} : "/usr/bin/vi");

##
## C O N S T A N T S
##

die "Invalid user name: $user" if !$user or ($user =~ m/[^A-Z0-9_]/i);
die "Must be run as root.\n" if $> != 0;

use DBI;

my ($dsn) = "DBI:mysql:OpenDarwin:localhost";
my ($user_name, $password);
my ($dbh,$sth);
my (@ary);

my $secret = "/var/opendarwin/secrets/od_approve_secret";
open OD_SECRET, $secret or die "$secret: $!\n";                  
chomp($user_name = <OD_SECRET>);
chomp($password = <OD_SECRET>);
close OD_SECRET;

$dbh = DBI->connect ($dsn, $user_name, $password, {RaiseError => 1});

$sth = $dbh->prepare ("SELECT user_id, ssh_key FROM od_users WHERE name='$user'");
$sth->execute;
($user_id, $ssh_key) = $sth->fetchrow_array ();
$sth->finish;

die "Unknown user: $user" if !$user_id;

# Create temporary file with contents of ssh_key.
my $filename = "/tmp/odvissh.tmp.$$";
open TMPFILE, ">$filename";
print TMPFILE $ssh_key;
close TMPFILE;

# Spawn the editor.
my $pid = fork;
if ($pid == 0) {
	exec $editor, $filename;
} else {
	wait;
	if (($? >> 8) == 0) {
                # If the editor successfully completed, read the modified file.
		open TMPFILE, $filename;
                my $buf = "";
		while (<TMPFILE>) {
                    $buf .= $_;
		}
                close TMPFILE;
                
                # Update the database.
                $buf = $dbh->quote($buf);
                $sth = $dbh->prepare("UPDATE od_users SET ssh_key=$buf WHERE user_id=$user_id");
                $sth->execute;
                $sth->finish;

                # Update the authorized_keys file.
                $ENV{'OD_USER_NAME'} = $user;
                #$ENV{'OD_PASSWORD'} = undef;
                `/usr/local/bin/od_set_sshkey`;
	}
}

exit 0;
